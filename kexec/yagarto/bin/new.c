//#define FW945
//#define FW995
#define FW_1500

#define NAND_DUMP
#define PKG_DECRYPTER

#ifdef PKG_DECRYPTER
#define IN_PATH			"host0:data/package_file_0.pkg"
#define OUT_PATH		"host0:data/package_file_0.dec"
#define ERR_PATH		"host0:data/package_file_0.err"
#define PKG_SIZE		0x9e480
#define PKG_TYPE		0x9 // 0x9 = slb2 package type, set accordingly.
#endif

#ifdef FW945
#define SYSMEMBASE 0x240000
#define IOBASE 0x390000
#define THREADBASE 0x2c0000
#define DPRNT 0x2B590+1
#define DELAYTHREAD 0x7539
#define ALLOCMEM 0x8A40+1
#define GETMEM 0x1A154+1
#define MEMCPYK2U 0x64AC+1
#define IOOPEN 0x22CD
#define IOCLOSE 0x2E49
#define IOREAD 0x2C99
#define IOWRITE 0x2BBD
#define CREATETHREAD 0x6A01
#define STARTTHREAD 0x55D9
#endif
#ifdef FW995
#define SYSMEMBASE 0x380000
#define IOBASE 0x4e0000       
#define THREADBASE 0x4a0000
#define ALLOCMEM 0x8C41
#define GETMEM 0x1B7D1
#define IOOPEN 0x1925
#define IOREAD  0x1a09
#define IOWRITE 0x1b65
#define IOCLOSE 0x1861
#define IOMOUNT 0x1CC89
#define IOUMOUNT 0x1CD85
#define DPRNT 0x2DFBD
#define MEMCPYK2U 0x3BCAEC
#define CREATETHREAD 0x6695
#define STARTTHREAD 0x2F95
#endif
#ifdef FW_1500
#define SYSMEMBASE 0x0
#define THREADBASE 0x0
#define IOBASE 0x0
#define DPRNT 0x49D0BC+1
#define IOOPEN 0x59073C+1
#define IOREAD 0x5907B8+1
#define IOWRITE 0x590838+1
#define IOCLOSE 0x5906B0+1
#define IOREMOVE 0x590BBC+1
#define IODOPEN 0x590A64+1
#define IODREAD 0x590AD0+1
#define IODCLOSE 0x590B48+1
#define CREATETHREAD 0x4C7F4C+1
#define STARTTHREAD 0x4C3E60+1
#define DELAYTHREAD 0x4C3920+1
#define ALLOCMEM 0x48B2F8+1
#define GETMEM 0x486254+1

#ifdef PKG_DECRYPTER
#define SceSblSsUpdateMgr_0x6E8DDAC4_OFFSET	0x1A006B8+1
#define SceSblSsUpdateMgr_0x1A39F6EE_OFFSET	0x1A0074C+1
#define SceSblSsUpdateMgr_0xC1792A1C_OFFSET	0x1A007E0+1
#define SceSblSsUpdateMgr_0xF403143E_OFFSET	0x1A009B4+1
#define SceSblSsUpdateMgr_0x4897AD56_OFFSET	0x1A00874+1
#define SceSblSsUpdateMgr_0x4C06F41C_OFFSET	0x1A008F8+1
#define SceSblSsUpdateMgr_0xBD677F5A_OFFSET	0x1A00960+1

#define sceSblSmCommStartSm_offset 			0x58A4FC+1 // NID: 992BB9DB
#define sceSblSmCommCallFunc_offset 		0x58A189+1 // NID: DB9FC204
#define ksceKernelMalloc_offset				0x485C80+1 // NID: C0A4D2F3 
#define KIOGETSTAT							0x590D04+1
#define GETPADDRLIST_OFFSET					0x48A4B0+1
#endif
#endif

#define SCE_FREAD       (0x0001)  
#define SCE_FWRITE      (0x0002) 
#define SCE_FAPPEND     (0x0100)  
#define SCE_FAPPEND     (0x0100)  
#define SCE_FCREAT      (0x0200)  
#define SCE_O_RDONLY    (SCE_FREAD)
#define SCE_O_WRONLY    (SCE_FWRITE)
#define SCE_O_RDWR      (SCE_FREAD|SCE_FWRITE)
#define SCE_O_APPEND    (SCE_FAPPEND)
#define SCE_O_CREAT     (SCE_FCREAT) 


#ifdef PKG_DECRYPTER
typedef signed char 	int8_t;
typedef unsigned char 	uint8_t;
typedef signed int 	int16_t;
typedef unsigned int 	uint16_t;
typedef signed long int 	int32_t;
typedef unsigned long int 	uint32_t;
typedef signed long long int 	int64_t;
typedef unsigned long long int 	uint64_t;

int (*SceSblSsUpdateMgr_0x6E8DDAC4)(int a1,int a2,int a3) = (void*) SceSblSsUpdateMgr_0x6E8DDAC4_OFFSET;
int (*SceSblSsUpdateMgr_0x1A39F6EE)(int,int,int) = (void*) SceSblSsUpdateMgr_0x1A39F6EE_OFFSET;
int (*SceSblSsUpdateMgr_0xC1792A1C)(int,int,int) = (void*) SceSblSsUpdateMgr_0xC1792A1C_OFFSET;
int (*SceSblSsUpdateMgr_0xF403143E)(int,int,int) = (void*) SceSblSsUpdateMgr_0xF403143E_OFFSET;
int (*SceSblSsUpdateMgr_0x4897AD56)(int,int,int) = (void*) SceSblSsUpdateMgr_0x4897AD56_OFFSET;
int (*SceSblSsUpdateMgr_0x4C06F41C)(int,int) = (void*) SceSblSsUpdateMgr_0x4C06F41C_OFFSET;
int (*SceSblSsUpdateMgr_0xBD677F5A)(int) = (void*) SceSblSsUpdateMgr_0xBD677F5A_OFFSET;


typedef struct SceSelfInfo // size is 0x90
{
	uint64_t program_authority_id;
	uint64_t padding1;
	uint8_t capability[0x20];
	uint8_t attribute[0x20];
	uint8_t padding2[0x10];
	uint8_t klicensee[0x10];
	uint32_t unk_70;
	uint32_t unk_74;
	uint32_t unk_78;
	uint32_t unk_7C;
	uint32_t unk_80; // ex: 0x10
	uint32_t unk_84;
	uint32_t unk_88;
	uint32_t unk_8C;
} SceSelfInfo;
typedef struct sm_comm_context // size is 0x130 as its name indicates
{
   uint32_t unk_0;
   uint32_t self_type; // kernel = 0, user = 1, SM = 2
   SceSelfInfo caller_self_info; // can be obtained with sceKernelGetSelfInfoForKernel
   SceSelfInfo called_self_info; // set by F00D in F00D SceSblSmCommContext130 response
   uint32_t pathId; // can be obtained with sceSblACMgrGetPathIdForKernel or sceIoGetPathIdExForDriver
   uint32_t unk_12C;
} Sm_comm_context;

typedef int64_t SceOff;
typedef int SceMode;
typedef struct SceDateTime {
	unsigned short year;
	unsigned short month;
	unsigned short day;
	unsigned short hour;
	unsigned short minute;
	unsigned short second;
	unsigned short microsecond;
}SceDateTime;
typedef struct SceIoStat {
	SceMode st_mode;
	unsigned int st_attr;
	SceOff st_size;
	SceDateTime st_ctime;
	SceDateTime st_atime;
	SceDateTime st_mtime;
	unsigned int st_private[6];
}SceIoStat;
typedef struct SceKernelAddrPair {
    uint32_t addr;
    uint32_t length;
} SceKernelAddrPair;

typedef struct SceKernelPaddrList {
    uint32_t size; // 0x14
    uint32_t output_buffer_size;
    uint32_t unk;
    uint32_t ret_count;
    SceKernelAddrPair *output_buffer;
} SceKernelPaddrList;

int (*sceKernelGetPaddrListForDriver)(const SceKernelAddrPair *input, SceKernelPaddrList *list) = (void*)GETPADDRLIST_OFFSET;
int (*ksceKernelMalloc)(int size) = (void*)ksceKernelMalloc_offset;
int (*sceSblSmCommStartSm)(int priority, char* sm_self_path, int num1, int num2, int num3, int num4, Sm_comm_context* ctx_130, int* id) = (void*)sceSblSmCommStartSm_offset;
int (*sceSblSmCommCallFunc)(int id, int service_id, int *f00d_resp, void *data, int size) 					= (void*)sceSblSmCommCallFunc_offset;
int (*sub_1A055C0)(int buffer) = (void*)0x1A055C0+1;

void  *memset(void *b, int c, int len)
{
  int           i;
  unsigned char *p = b;
  i = 0;
  while(len > 0)
    {
      *p = c;
      p++;
      len--;
    }
  return(b);
}


#endif

typedef unsigned long uintptr_t;
typedef unsigned long size_t;

int kernel_start(int size, void* argp);
int thread_start(int size, void* argp);

void (*prnt)(const char*,...) = (void*)DPRNT; 
void memcpy(void *dest, void *src, size_t n);

int g_bDone = 0;

int kernel_start(int size, void* argp)
{
	int (*sceKernelCreateThread)(const char* a1, void* a2, int a3, int a4, unsigned int a5, int a6, void* a7) = (void*) THREADBASE + CREATETHREAD ;
	int (*sceKernelStartThread)(int a1, unsigned int a2, void* a3) = (void*) THREADBASE + STARTTHREAD ;
	int (*sceKernelGetMemBlockBase)(int,void*) = (void*) SYSMEMBASE + GETMEM; 
	int (*sceKernelAllocMemBlock)(char*,int,int,int) = (void*) SYSMEMBASE + ALLOCMEM;     
	int (*sceIoOpen)(const char*,int,int) = (void*) IOBASE + IOOPEN; 
	int (*sceIoRead)(int,void*,int) = (void*) IOBASE + IOREAD;  
	int (*sceIoWrite)(int,void*,int) = (void*) IOBASE + IOWRITE; 
	int (*sceIoClose)(int) = (void*) IOBASE + IOCLOSE; 
	
	prnt("Hello World from Kernel! (Main Thread)\n");
	
	int threadArgs[2], threadID = sceKernelCreateThread("kernel_thread", thread_start, 0x10000100, 0x4000, 0, 0x10000, 0);
	sceKernelStartThread(threadID, 8, threadArgs);

	while(g_bDone == 0) { }

	return 0x420;
}

int thread_start(int size, void* argp)
{
	int (*sceKernelCreateThread)(const char* a1, void* a2, int a3, int a4, unsigned int a5, int a6, void* a7) = (void*) THREADBASE + CREATETHREAD ;
	int (*sceKernelStartThread)(int a1, unsigned int a2, void* a3) = (void*) THREADBASE + STARTTHREAD ;
	int (*sceKernelGetMemBlockBase)(int,void*) = (void*) SYSMEMBASE + GETMEM; 
	int (*sceKernelAllocMemBlock)(char*,int,int,int) = (void*) SYSMEMBASE + ALLOCMEM;     
	int (*sceIoOpen)(const char*,int,int) = (void*) IOBASE + IOOPEN; 
	int (*sceIoRead)(int,void*,int) = (void*) IOBASE + IOREAD;  
	int (*sceIoWrite)(int,void*,int) = (void*) IOBASE + IOWRITE; 
	int (*sceIoClose)(int) = (void*) IOBASE + IOCLOSE; 

	
	#if defined(PKG_DECRYPTER) && defined(FW_1500)
	int (*sceKernelDelayThread)(int a1) = (void*) THREADBASE + DELAYTHREAD;	
	#endif
	
	unsigned char* buffer;
	unsigned int bufferSize = 0x100000;
	
	prnt("Hello World from Kernel! (Kernel Thread)\n");

#	ifdef NAND_DUMP
	int read = 0, writeFile = 0, 
	bufferID = sceKernelAllocMemBlock("kBuffer", 0x10208006, bufferSize, 0), 
	ret = sceKernelGetMemBlockBase(bufferID, &buffer);

	prnt("Dumping NAND..\n");
    ret = sceIoOpen("sdstor0:int-lp-act-entire", 0x4000003, 0);
	writeFile = sceIoOpen("host0:nand.bin", SCE_O_WRONLY | SCE_O_CREAT | SCE_O_APPEND, 6);
	
	prnt("sceIoOpen for sdstor0 returned 0x%x\n", ret);
	prnt("sceIoOpen for writeFile returned 0x%x\n", writeFile);

	while ((read = sceIoRead(ret, buffer, bufferSize)) > 0) 
		sceIoWrite(writeFile, buffer, bufferSize);
	
	sceIoClose(ret);
	sceIoClose(writeFile);

	prnt("Finished dumping NAND..\n");
#	endif
	
#	ifdef PKG_DECRYPTER
	sceKernelDelayThread(5*100*100);
	
	int kbufid = sceKernelAllocMemBlock("SceSblUsKernel0", 0x10208006, bufferSize, 0);
	prnt("sceKernelAllocMemBlock returned %d\n", kbufid);
    
	ret = sceKernelGetMemBlockBase(kbufid, &buffer);
	prnt("sceKernelGetMemBlockBase returned 0x%x..\n", ret);	

	int fd = sceIoOpen(IN_PATH, SCE_O_RDONLY, 6);
	prnt("sceIoOpen returned 0x%x\n", fd); 
	
	ret = sceIoRead(fd, buffer, PKG_SIZE);
	prnt("sceIoRead returned 0x%08x\n", ret);

	ret = sceIoClose(fd);
	prnt("sceIoClose returned 0x%08x\n", ret);
	
	int buffer2[4] = { 0, PKG_TYPE, buffer, PKG_SIZE};
	ret = sub_1A055C0(buffer2);
	prnt("sub_1A055C0 returned 0x%08X\n", ret);

	sceKernelDelayThread(5*1000*100);

	prnt("About to open output file..\n");

	fd = sceIoOpen(OUT_PATH, SCE_O_CREAT | SCE_O_WRONLY, 6);
	prnt("sceIoOpen returned 0x%x\n", fd); 

	ret = sceIoWrite(fd, buffer, PKG_SIZE);
	prnt("sceIoWrite returned 0x%08x\n", ret);

	ret = sceIoClose(fd);
	prnt("sceIoClose returned 0x%08x\n", ret);
	sceKernelDelayThread(5*1000*100);

	prnt("Finished pkg decryption\n");
	sceKernelDelayThread(15*100*100);
#	endif
	
	prnt("Kernel thread finished!\n");
	
	g_bDone = 1;
    return 0x421;
}

void memcpy(void *dest, void *src, size_t n)
{ 
   char *csrc = (char *)src, *cdest = (char *)dest; 
   for (int i=0; i<n; ++i) 
       cdest[i] = csrc[i]; 
} 
