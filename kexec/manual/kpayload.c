#define ksceIoOpen_offset                                0x291C98+1              // 0x75192972
#define ksceIoRead_offset                                0x291770+1              // 0xE17EFC03
#define ksceIoClose_offset                               0x291764+1              // 0xF99DD8A3
#define ksceIoWrite_offset                               0x2917E0+1              // 0x21EE91F0
#define PRNT											 0x26A9B4+1
#define CREATETHREAD									 0x2A63D0+1
#define STARTTHREAD										 0x2A566C+1
#define GETMEMBLOCK										 0x259A9C+1
#define ALLOCMEM										 0x2481C4+1

int thread_start(int size, void* argp);

int kernel_start(int size, void* argp)
{
	void (*prnt)(const char*, ...) = (void*)PRNT;
	int (*sceKernelCreateThread)(const char* a1, void* a2, int a3, int a4, unsigned int a5, int a6, void* a7) = (void*)CREATETHREAD;
	int (*sceKernelStartThread)(int a1, unsigned int a2, void* a3) = (void*)STARTTHREAD;

	prnt("Hello World from Kernel! (Main Thread)\n");
	
	int threadArgs[2], threadID = sceKernelCreateThread("kernel_thread", thread_start, 0x10000000, 0x4000, 0, 0x10000, 0);
	sceKernelStartThread(threadID, 8, threadArgs);

	prnt("Goodbye World! (Main Thread)\n");
	while (1) {}
	return 0x420;
}

int thread_start(int size, void* p)
{
	void (*prnt)(const char*, ...) = (void*)PRNT;

	int (*sceKernelGetMemBlockBase)(int, void*) = (void*)GETMEMBLOCK;
	int (*sceKernelAllocMemBlock)(char*, int, int, int) = (void*)ALLOCMEM;

	int (*sceIoOpen)(const char*, int, int) = (void*)(ksceIoOpen_offset);
	int (*sceIoRead)(int, void*, int) = (void*)(ksceIoRead_offset);
	int (*sceIoWrite)(int, void*, int) = (void*)(ksceIoWrite_offset);
	int (*sceIoClose)(int) = (void*)(ksceIoClose_offset);

	unsigned char* buffer;
	unsigned int bufferSize = 0x1000000;

	int read = 0, writeFile = 0,
		bufferID = sceKernelAllocMemBlock("kBuffer", 0x10F0D006, bufferSize, 0),
		ret = sceKernelGetMemBlockBase(bufferID, &buffer);

	int (*sceKernelSetThreadAccessLevel)(int) = (void*)0x2A082C + 1;
	int prevAccess = sceKernelSetThreadAccessLevel(0x80);
	prnt("prevAccess = 0x%X\n", prevAccess);

	prnt("Dumping NAND..\n");
	ret = sceIoOpen("sdstor0:int-lp-act-entire", 0x4000003, 0);
	writeFile = sceIoOpen("host0:nand.bin", 0x602, 6);

	prnt("sceIoOpen for sdstor0 returned 0x%x\n", ret);
	prnt("sceIoOpen for writeFile returned 0x%x\n", writeFile);

	while ((read = sceIoRead(ret, buffer, bufferSize)) > 0)
		sceIoWrite(writeFile, buffer, bufferSize);

	sceIoClose(ret);
	sceIoClose(writeFile);

	sceKernelSetThreadAccessLevel(prevAccess);

	prnt("Finished dumping NAND..\n");
	return 0x421;
}